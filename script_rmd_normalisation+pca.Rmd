---
title: "Normalisation and PCA on OTU data set"
author: "David R. M. Graf"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
graphics.off()
```
# Script for Normalisation of OTU dataset and normalisation
Packages used for the analysis:
* readxl
* zCompositons
+ to remove non-zero entries from the raw data matrix
* CoDaSeq
+ to filter the dataset and perform the variance stabilising transformation
* robCompositions
+ to calculate Aitchison distancs
* ggbiplot
+ to visualise PCAs
```{r, results="hide"}
library(readxl)
library(zCompositions)
library(CoDaSeq)
library(robCompositions)
library(ggbiplot)
```

```{r, echo=FALSE}
threshapply <- function(input_data, method){
  if(!is.character(method)) stop('method must be character')
  if(!is.matrix(input_data)) stop('input_data must be a matrix')
  if (method=="90 percent"){
    for (i in 1:nrow(input_data)){
      output_data <- input_data
      output_data[i, order(input_data[i, ], decreasing=T)[cumsum(input_data[i, order(input_data[i, ], decreasing=T)])/sum(input_data[i, ])>0.90]] <- 0
    }
  }else if(method == "95 percent"){
    for (i in 1:nrow(input_data)){
      output_data <- input_data
      output_data[i, order(input_data[i, ], decreasing=T)[cumsum(input_data[i, order(input_data[i, ], decreasing=T)])/sum(input_data[i, ])>0.95]] <- 0
    }
  }else if(method == "99 percent"){
    for (i in 1:nrow(input_data)){
      output_data <- input_data
      output_data[i, order(input_data[i, ], decreasing=T)[cumsum(input_data[i, order(input_data[i, ], decreasing=T)])/sum(input_data[i, ])>0.99]] <- 0
    }
  }else if(method == "0.05 percent"){
    keep.cols <- colSums(input_data)/sum(input_data)>=5e-04
    output_data <- input_data[, keep.cols]
  }else if(method == "0.005 percent"){
    keep.cols <- colSums(input_data)/sum(input_data)>=5e-05
    output_data <- input_data[, keep.cols]
  }
  output_data <- output_data[, colSums(output_data)!=0]
  return(output_data)
}

```
### data plumbing

read in raw data and auxiliary info
transpose raw data and reduce minimal proportional abundance
```{r}
sequ <- read.csv("Sequences_Hausgarten2009-2016_ohne_header.csv", sep = ";")
sequ <- t(sequ)
stat_names <- read_excel("Sequences_Hausgarten_station_data_revised.xlsx")
dim.pre <- dim(sequ)
sequ <- threshapply(sequ, "0.05 percent")

#' number of columns thrown out
dim.pre[2] - dim(sequ)[2]

```


